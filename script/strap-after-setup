#!/usr/bin/env bash
### ----------------- Bootstrap post-installation scripts ----------------- ###
# Run by run_dotfile_scripts in bootstrap.sh

# Run scripts: scripts must be executable (chmod +x)
echo "-> Running scripts from script/strap-after-setup"

"$HOME"/.dotfiles/script/symlink.sh

if command -v npm 1>/dev/null; then
  sudo "$HOME"/.dotfiles/script/npm-globals.sh
else
  echo "npm not found. Skipping npm-globals.sh."
fi

if [ "$(uname -s)" = "Darwin" ]; then
  "$HOME"/.dotfiles/script/macos.sh
else
  echo "Not macOS. Skipping macos.sh."
fi

declare -a VSCODES
for i in {code,code-exploration,code-insiders,code-server,codium}; do
  if command -v "$i" >/dev/null 2>&1; then VSCODES+=("$i"); else continue; fi
done
if [ "$(whoami)" = "codespace" ]; then
  echo "Error: Codespaces VSCode CLI can't install extensions."
else
  "$HOME"/.dotfiles/script/vscode-extensions.sh "${VSCODES[@]}"
fi

# Set shell
if ! [[ $SHELL =~ "zsh" ]] && command -v zsh >/dev/null 2>&1; then
  echo "-> Changing shell to Zsh. Password entry required."
  if [ "$(uname)" = "Linux" ]; then
    command -v zsh | sudo tee -a /etc/shells
    sudo chsh -s "$(command -v zsh)" "$USER"
  else
    chsh -s "$(command -v zsh)"
  fi
else
  echo "-> Shell is already set to Zsh."
fi

RAW="https://raw.githubusercontent.com"
# Install prompt
# pure prompt: https://github.com/sindresorhus/pure
mkdir -p "$HOME/.zsh"
git clone https://github.com/sindresorhus/pure.git "$HOME/.zsh/pure"
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git \
  "$HOME/.zsh/zsh-syntax-highlighting"
# zsh4humans and powerlevel10k: https://github.com/romkatv/zsh4humans
# sh -c "$(curl -fsSL $RAW/romkatv/zsh4humans/v5/install)"

# Install Poetry: https://python-poetry.org/docs/
echo "-> Installing Poetry for Python packaging and dependency management"
curl -fsSL $RAW/python-poetry/poetry/master/get-poetry.py | python3 -
